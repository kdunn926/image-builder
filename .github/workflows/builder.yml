name: Automated Image Builds
on:
  push:
    paths-ignore:
    # Changes to these artifacts are autogenerated by this workflow
    # ignore them to prevent an infinite CI loop
    - '*.md'
jobs:
  build:
    runs-on: ubuntu-18.04
    env:
      VAR: ":0"
    continue-on-error: true
    steps:
      - name: Checkout source
        uses: actions/checkout@v2

      - name: Install dependencies
        run: sudo apt-get install -y dosfstools git kpartx wget parted

      - name: Execute build
        id: build
        run: |
          ./RootStock-NG.sh -c machinekit-debian-stretch
          IMG_DIR=`ls -d deploy/debian*/`
          cd ${IMG_DIR}
          sudo ./setup_sdcard.sh --img-4gb bone-example --dtb beaglebone --distro-bootloader --enable-cape-universal --enable-uboot
          echo "::set-output name=image::${IMG_DIR}/bone-example-4gb.img"

      - name: Create release and upload image
        uses: softprops/action-gh-release@v1
        id: release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          draft: false
          prerelease: false
          release_name: "Debian Machinekit 5.9.1-bone-rt-r12"
          tag_name: deb-mk-5.9.1-bone-rt-r12
          files: ${{ steps.build.outputs.image }}
          #asset_name: "debian-machinekit-5.9.1-bone-rt-r12.img"
          #asset_content_type: application/octetâ€‘stream
